name: Terraform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_INPUT: false
  TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
  TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
  TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
  TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
  TF_VAR_region: ${{ vars.OCI_REGION }}
  TF_VAR_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
  TF_VAR_backend_bucket: ${{ vars.TF_BACKEND_BUCKET }}
  TF_VAR_backend_state_key: ${{ vars.TF_BACKEND_STATE_KEY }}
  TF_VAR_s3_access_key: ${{ secrets.S3_ACCESS_KEY }}
  TF_VAR_s3_secret_key: ${{ secrets.S3_SECRET_KEY }}

jobs:
  plan:
    name: terraform plan
    runs-on: ubuntu-latest
    outputs:
      plan_path: ${{ steps.store-plan.outputs.plan_path }}
      s3_endpoint: ${{ steps.export-endpoint.outputs.s3_endpoint }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Definir defaults para variáveis não sensíveis (se ausentes)
        run: |
          [ -z "${TF_VAR_project_prefix}" ] && echo "TF_VAR_project_prefix=prod" >> $GITHUB_ENV
          [ -z "${TF_VAR_vcn_cidr}" ] && echo "TF_VAR_vcn_cidr=10.0.0.0/16" >> $GITHUB_ENV
          [ -z "${TF_VAR_public_subnet_cidr}" ] && echo "TF_VAR_public_subnet_cidr=10.0.1.0/24" >> $GITHUB_ENV
          [ -z "${TF_VAR_instance_shape}" ] && echo "TF_VAR_instance_shape=VM.Standard.E2.1.Micro" >> $GITHUB_ENV
          [ -z "${TF_VAR_instance_ocpus}" ] && echo "TF_VAR_instance_ocpus=1" >> $GITHUB_ENV
          [ -z "${TF_VAR_instance_memory_gbs}" ] && echo "TF_VAR_instance_memory_gbs=8" >> $GITHUB_ENV
          [ -z "${TF_VAR_image_operating_system}" ] && echo "TF_VAR_image_operating_system=Oracle Linux" >> $GITHUB_ENV
          [ -z "${TF_VAR_image_operating_system_version}" ] && echo "TF_VAR_image_operating_system_version=9" >> $GITHUB_ENV
          # Defaults backend se ausentes
          REPO_SLUG="${GITHUB_REPOSITORY#*/}" || REPO_SLUG="repo"
          SANITIZED=$(echo "$REPO_SLUG" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9-')
          [ -z "${TF_VAR_backend_bucket}" ] && echo "TF_VAR_backend_bucket=tfstate-${SANITIZED}" >> $GITHUB_ENV
          [ -z "${TF_VAR_backend_state_key}" ] && echo "TF_VAR_backend_state_key=terraform/${SANITIZED}/terraform.tfstate" >> $GITHUB_ENV

      - name: Verificar variáveis obrigatórias de backend (exceto endpoint que será calculado)
        run: |
          missing=""
          for v in TF_VAR_backend_bucket TF_VAR_backend_state_key TF_VAR_s3_access_key TF_VAR_s3_secret_key; do
            if [ -z "${!v}" ]; then echo "Variável $v ausente"; missing="1"; fi
          done
          [ -n "$missing" ] && exit 1 || echo "Variáveis essenciais presentes"

      - name: Materializar chave privada para OCI CLI
        run: |
          echo "Salvando chave privada em arquivo temporário para uso do OCI CLI"
          echo "${TF_VAR_private_key}" > $RUNNER_TEMP/oci_api_key.pem
          chmod 600 $RUNNER_TEMP/oci_api_key.pem

      - name: Instalar OCI CLI (para bootstrap do bucket)
        run: |
          pip install --quiet --upgrade oci-cli
          oci --version

      - name: Configurar OCI CLI
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ env.TF_VAR_region }}
          key_file=$RUNNER_TEMP/oci_api_key.pem
          EOF
          chmod 600 ~/.oci/config

      - name: Bootstrap bucket Object Storage (idempotente + calcular endpoint se ausente)
        run: |
          BUCKET="${TF_VAR_backend_bucket}"
          COMPARTMENT="${TF_VAR_compartment_ocid}"
          echo "Verificando namespace..."
          NAMESPACE=$(oci os ns get --query 'data' --raw-output)
          echo "Namespace: $NAMESPACE"
          if [ -z "${TF_VAR_s3_endpoint}" ]; then
            ENDPOINT="https://${NAMESPACE}.compat.objectstorage.${TF_VAR_region}.oraclecloud.com"
            echo "TF_VAR_s3_endpoint=${ENDPOINT}" >> $GITHUB_ENV
            export TF_VAR_s3_endpoint=${ENDPOINT}
            echo "Endpoint S3 calculado: ${ENDPOINT}"
          else
            echo "Usando endpoint fornecido: ${TF_VAR_s3_endpoint}"
          fi
          echo "Checando se bucket existe..."
          if oci os bucket get --namespace-name "$NAMESPACE" --bucket-name "$BUCKET" >/dev/null 2>&1; then
            echo "Bucket '$BUCKET' já existe."
          else
            echo "Criando bucket '$BUCKET' no compartment $COMPARTMENT"
            oci os bucket create --name "$BUCKET" --compartment-id "$COMPARTMENT" --public-access-type NoPublicAccess --storage-tier Standard || { echo "Falha ao criar bucket"; exit 1; }
          fi
          echo "Bucket pronto."

      - name: Exportar endpoint calculado
        id: export-endpoint
        run: |
          echo "s3_endpoint=${TF_VAR_s3_endpoint}" >> $GITHUB_OUTPUT

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          cli_config_credentials_token: ${{ secrets.TF_CLOUD_TOKEN || '' }}

      - name: Cache plugins Terraform
        uses: actions/cache@v4
        with:
          path: .terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Terraform Init
        run: |
          terraform init -reconfigure -input=false \
            -backend-config="bucket=${TF_VAR_backend_bucket}" \
            -backend-config="key=${TF_VAR_backend_state_key}" \
            -backend-config="endpoint=${TF_VAR_s3_endpoint}" \
            -backend-config="access_key=${TF_VAR_s3_access_key}" \
            -backend-config="secret_key=${TF_VAR_s3_secret_key}" \
            -backend-config="region=us-east-1" \
            -backend-config="skip_credentials_validation=true" \
            -backend-config="skip_region_validation=true" \
            -backend-config="skip_requesting_account_id=true" \
            -backend-config="force_path_style=true" \
            -backend-config="encrypt=true"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Fmt (check)
        run: terraform fmt -check -recursive || true

      - name: Terraform Plan
        id: plan
        run: |
          set -o pipefail
          terraform plan -no-color -out=tfplan | tee plan.log

      - name: Armazenar plano como artefato
        id: store-plan
        run: |
          echo "plan_path=tfplan" >> $GITHUB_OUTPUT

      - name: Upload artefatos (plan + logs)
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            tfplan
            plan.log

      - name: Resumo do PLAN
        run: |
          echo '### Terraform PLAN - Resumo' >> $GITHUB_STEP_SUMMARY
          if grep -qE '^Plan:' plan.log; then
            RESUMO=$(grep -E '^Plan:' plan.log | tail -n 1)
            echo "Resumo: $RESUMO" >> $GITHUB_STEP_SUMMARY
          elif grep -q 'No changes.' plan.log; then
            echo 'No changes.' >> $GITHUB_STEP_SUMMARY
          else
            echo '(Não encontrado padrão Plan: ou No changes.)' >> $GITHUB_STEP_SUMMARY
          fi
          echo '\nPrimeiras linhas:' >> $GITHUB_STEP_SUMMARY
          head -n 25 plan.log | sed 's/`/\`/g' >> $GITHUB_STEP_SUMMARY

      - name: Limpeza chave privada
        if: always()
        run: rm -f $RUNNER_TEMP/oci_api_key.pem

  apply:
    name: terraform apply
    if: github.ref == 'refs/heads/main'
    needs: plan
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Recuperar artefatos do PLAN
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: ./

      - name: Definir endpoint do backend (do job plan)
        run: |
          if [ -n "${{ needs.plan.outputs.s3_endpoint }}" ]; then
            echo "Usando endpoint S3 do plan: ${{ needs.plan.outputs.s3_endpoint }}"
            echo "TF_VAR_s3_endpoint=${{ needs.plan.outputs.s3_endpoint }}" >> $GITHUB_ENV
          else
            echo "Saída s3_endpoint não encontrada; falhando para evitar divergência de backend."
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Cache plugins Terraform
        uses: actions/cache@v4
        with:
          path: .terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Instalar OCI CLI (apply job)
        run: |
          pip install --quiet --upgrade oci-cli
          oci --version

      - name: Apply (usando plano salvo)
        run: |
          echo "${TF_VAR_private_key}" > $RUNNER_TEMP/oci_api_key.pem
          chmod 600 $RUNNER_TEMP/oci_api_key.pem
          mkdir -p ~/.oci
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ env.TF_VAR_region }}
          key_file=$RUNNER_TEMP/oci_api_key.pem
          EOF
          chmod 600 ~/.oci/config
          terraform init -reconfigure -input=false \
            -backend-config="bucket=${TF_VAR_backend_bucket}" \
            -backend-config="key=${TF_VAR_backend_state_key}" \
            -backend-config="endpoint=${TF_VAR_s3_endpoint}" \
            -backend-config="access_key=${TF_VAR_s3_access_key}" \
            -backend-config="secret_key=${TF_VAR_s3_secret_key}" \
            -backend-config="region=us-east-1" \
            -backend-config="skip_credentials_validation=true" \
            -backend-config="skip_region_validation=true" \
            -backend-config="skip_requesting_account_id=true" \
            -backend-config="force_path_style=true" \
            -backend-config="encrypt=true"
          terraform apply -no-color -input=false -auto-approve tfplan | tee apply.log

      - name: Upload artefatos APPLY
        uses: actions/upload-artifact@v4
        with:
          name: terraform-apply
          path: apply.log

      - name: Resumo do APPLY
        run: |
          echo '### Terraform APPLY - Resumo' >> $GITHUB_STEP_SUMMARY
          if grep -q 'Apply complete!' apply.log; then
            RES=$(grep 'Apply complete!' apply.log | tail -n 1)
            echo "${RES}" >> $GITHUB_STEP_SUMMARY
          elif grep -q 'Destroy complete!' apply.log; then
            RES=$(grep 'Destroy complete!' apply.log | tail -n 1)
            echo "${RES}" >> $GITHUB_STEP_SUMMARY
          else
            echo '(Não encontrado Apply complete!/Destroy complete!)' >> $GITHUB_STEP_SUMMARY
          fi
          echo '\nÚltimas linhas:' >> $GITHUB_STEP_SUMMARY
          tail -n 25 apply.log | sed 's/`/\`/g' >> $GITHUB_STEP_SUMMARY

      - name: Limpeza chave privada
        if: always()
        run: rm -f $RUNNER_TEMP/oci_api_key.pem
